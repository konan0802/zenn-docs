---
title: "Embulkã‚’DockerÃ—Lambdaã§å‹•ã‹ã™ï¼ˆé–‹ç™ºï¼†æœ¬ç•ªç’°å¢ƒï¼‰"
emoji: "ğŸ‹"
type: "tech"
topics:
  - "docker"
  - "python"
  - "lambda"
  - "embulk"
published: true
published_at: "2025-07-23 22:29"
---

## ã¯ã˜ã‚ã«

Embulkã‚’è§¦ã£ã¦æœ€åˆã«æ€ã£ãŸã®ã¯ã€Œã“ã‚Œã€ã©ã“ã§å‹•ã‹ãã†ã‹ï¼Ÿï¼Ÿã€
ç›´æ„Ÿçš„ã«LambdaãŒè‰¯ã„ãªã¨æ€ã£ãŸã‚‚ã®ã®ã€èª¿ã¹ã¦ã‚‚ã‚ã¾ã‚Šæƒ…å ±ã‚‚ãªãã€ã‚¹ãƒƒã‚­ãƒªã—ãŸæ§‹æˆã‚’å–ã‚‹ã®ã«ã‚‚è‰²ã€…æ¤œè¨ã—ãŸã®ã§ã‚ªã‚¹ã‚¹ãƒ¡ã¨ã—ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

ã¾ãŸä»¥å‰ã€åŸ·ç­†ã—ãŸ[Dockerã‚’æ´»ç”¨ã—ãŸLambdaã®é–‹ç™ºï¼†æœ¬ç•ªç’°å¢ƒã®ãŠã™ã™ã‚æ§‹æˆ](https://zenn.dev/konan/articles/efd004b1810463)ã‚’å…ƒã«ã€DockerÃ—Lambdaã§æœ¬ç•ªç’°å¢ƒã‚’æ§‹ç¯‰ã—ãŸä¸Šã§ã€é–‹ç™ºç’°å¢ƒã‚‚ä¸€è²«æ€§ã®ã‚ã‚‹ä½œã‚Šã«ã—ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/ef8125b9a623-20240622.png)
*â€»ã©ã£ã¡ã‚‚ã‚¯ã‚¸ãƒ©ï¼ï¼*

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

æœ¬è¨˜äº‹ã§è§£èª¬ã™ã‚‹ã‚³ãƒ¼ãƒ‰ä¸€å¼ã¯ã€ä»¥ä¸‹ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ï¼š

**ğŸ”— [embulk-lambda-container](https://github.com/konan0802/embulk-lambda-container)**

- å®Œå…¨ãªDockerfileï¼ˆãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼‰
- Lambda ãƒãƒ³ãƒ‰ãƒ©ã®å®Ÿè£…ä¾‹  
- 3ç¨®é¡ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPostgreSQLã€MySQLã€MongoDB â†’ Redshiftï¼‰
- ç’°å¢ƒæ§‹ç¯‰ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã®æ‰‹é †æ›¸

è¨˜äº‹ã¨åˆã‚ã›ã¦ã”æ´»ç”¨ãã ã•ã„ã€‚

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
embulk-lambda-container/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ embulk.properties
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config_users.yml.liquid
â”‚   â””â”€â”€ ... (å„ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py      # Lambdaãƒãƒ³ãƒ‰ãƒ©
â”‚   â””â”€â”€ requirements.txt
â””â”€â”€ README.md
```

## Embulk Ã— Lambda ã®èª²é¡Œ
Embulk ã¯ Java è£½ã§ **JAR ãŒ 100 MB ã‚’è¶…ãˆ**ã€åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ JVM ãƒ™ãƒ¼ã‚¹â€•â€•ãã®ã¾ã¾ Lambda ã«çªã£è¾¼ã‚€ã¨ä¸‹è¨˜ã®å•é¡Œã«çªãå½“ãŸã‚Šã¾ã™ã€‚

- ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆZIP 50 MBï¼‰
- ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“ã®å¢—å¤§
- ãƒ¡ãƒ¢ãƒª / ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãŒé›£ã—ã„

ãã“ã§ä»Šå›ã¯ **Docker ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸** ã§ Lambda ã‚’å‹•ã‹ã—ã€`aws-lambda-java` ã¨ `aws-lambda-python` ã®ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã§æœ€å°æ§‹æˆã‚’ç›®æŒ‡ã—ã¾ã—ãŸã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦
- **Lambda (Container image)** : Embulk å®Ÿè¡Œæœ¬ä½“
- **ECR** : ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒª
- **EventBridge** : ãƒ†ãƒ¼ãƒ–ãƒ«å˜ä½ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ

```mermaid
flowchart TD
  EB(EventBridge ãƒ«ãƒ¼ãƒ«) -->|Invoke| L(Lambda: embulk-lambda-container)
  L --> RS[(Redshift)]
  L --> S3[(S3  ä¸€æ™‚é ˜åŸŸ)]
  L --> DB[(å„ç¨® DB / MongoDB)]
```

## Dockerfileã®è§£èª¬
### ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®æ§‹æˆ

**ã‚¹ãƒ†ãƒ¼ã‚¸1: Java builder** - Embulkã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æº–å‚™
```dockerfile
FROM --platform=linux/amd64 amazon/aws-lambda-java:8.al2 AS java-builder

# Embulkæœ¬ä½“ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ARG embulk_version=0.11.0
RUN wget -O /embulk/bin/embulk https://github.com/embulk/embulk/releases/download/v${embulk_version}/embulk-${embulk_version}.jar
# ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡¦ç†...
```

**ã‚¹ãƒ†ãƒ¼ã‚¸2: Lambda runtime** - å®Ÿè¡Œç’°å¢ƒã®æ§‹ç¯‰
```dockerfile
FROM --platform=linux/amd64 amazon/aws-lambda-python:3.11

# ã‚¹ãƒ†ãƒ¼ã‚¸1ã‹ã‚‰Embulkã‚’ã‚³ãƒ”ãƒ¼
COPY --from=java-builder /embulk /embulk

# Java runtime ã¨Pythonä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN yum install -y java-1.8.0-openjdk-headless
COPY src/main.py /var/task/
CMD [ "main.lambda_handler" ]
```

> ğŸ“„ **å®Œå…¨ãªDockerfile**: [ãƒªãƒã‚¸ãƒˆãƒªã§ç¢ºèª](https://github.com/konan0802/embulk-lambda-container/blob/main/Dockerfile)

### ğŸ”‘ è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

1. **ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å›ºå®š**: `--platform=linux/amd64` ã§Apple Siliconã§ã‚‚CI/CDã‚’å®‰å®šåŒ–
2. **ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸æœ€é©åŒ–**: Embulkæº–å‚™ã¨å®Ÿè¡Œç’°å¢ƒã‚’åˆ†é›¢ã—ã¦è»½é‡åŒ–ï¼ˆç´„300MBï¼‰
3. **JRubyå®‰å®šç‰ˆæ¡ç”¨**: 9.3.10ã‚’ä½¿ç”¨ï¼ˆ9.4ç³»ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå›é¿ï¼‰
4. **Pythonãƒãƒ³ãƒ‰ãƒ©**: ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆçŸ­ç¸®ã®ãŸã‚Pythonã§ãƒ©ãƒƒãƒ—
5. **ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–**: ä¾å­˜é–¢ä¿‚ã‚’å…ˆã«ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–

## Lambda ãƒãƒ³ãƒ‰ãƒ©ã®å®Ÿè£…

### æ ¸ã¨ãªã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼

```python
def lambda_handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    # 1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«åã®å–å¾—
    config_file = event.get("config_file_name")
    
    # 2. Embulkã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æ¸ˆã¿ï¼‰
    cmd = ["java", "-Xmx6g", "-Xms2g", "-XX:+UseG1GC", 
           "-jar", "/embulk/bin/embulk", "run", config_path]
    
    # 3. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ï¼ˆ13åˆ†ï¼‰
    result = subprocess.run(cmd, timeout=780)
    
    return {"statusCode": 200}
```

> ğŸ“„ **å®Œå…¨ãªå®Ÿè£…**: [main.py](https://github.com/konan0802/embulk-lambda-container/blob/main/src/main.py)

### ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ

1. **ãƒ¡ãƒ¢ãƒªç®¡ç†**: `-Xmx6g / -Xms2g` ã§å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œ
2. **GCæœ€é©åŒ–**: `G1GC` + `MaxGCPauseMillis=200` ã§åœæ­¢æ™‚é–“æœ€å°åŒ–  
3. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡**: Lambdaä¸Šé™15åˆ†ã®85%ï¼ˆ13åˆ†ï¼‰ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
4. **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå¯¾å¿œ**: `__main__`ãƒ–ãƒ­ãƒƒã‚¯ã§é–‹ç™ºæ™‚ã‚‚åŒã˜ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹

## Embulk è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹ï¼‰
`config/config_users.yml.liquid`
```yaml
in:
  type: postgresql
  host: {{ env.DB_HOST }}
  table: users
  select: "id, username, email, created_at, updated_at, status"
  ...
filters:
  - type: typecast
out:
  type: redshift
  table: users
  mode: merge
  merge: [id]
```
Liquid ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ç’°å¢ƒå¤‰æ•°ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã ã‘ã§ **æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚‚ã‚³ãƒ”ãƒšã§å¯¾å¿œ** ã§ãã¾ã™ã€‚

## å®Ÿéš›ã®ä½¿ç”¨æ–¹æ³•

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã®å‹•ä½œç¢ºèª

```bash
# 1. ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.sample .env
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦DBæ¥ç¶šæƒ…å ±ã‚’è¨­å®š

# 2. ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
docker build -t embulk-lambda-container .

# 3. å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
docker run --rm --env-file .env --entrypoint python embulk-lambda-container \
  main.py '{"config_file_name":"config_users.yml.liquid"}'
```

### æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ECRã«ãƒ—ãƒƒã‚·ãƒ¥å¾Œã€Lambdaé–¢æ•°ã§ã€Œæ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã™ã‚‹ã ã‘
aws ecr get-login-password | docker login --username AWS --password-stdin $ECR_URL
docker push $ECR_URL/embulk-lambda-container:latest
```

## ARM64 (Apple Silicon) ã§ã®æ³¨æ„
ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ `linux/amd64` ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã¾ã™ã€‚M1/M2 Mac ã§ã¯ Rosetta ã§å‹•ããŸã‚ **3ã€œ5 å€é…ã** ãªã‚Šã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã¯ç°¡æ˜“ç¢ºèªã«ç•™ã‚ã€CI ã§ã¯ x86_64 ãƒ©ãƒ³ãƒŠãƒ¼ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

## ã¾ã¨ã‚
- Embulk v0.11 ã‚’ **æœ€å°ã‚³ãƒ¼ãƒ‰** + **å˜ä¸€ Dockerfile** ã§ Lambda ã«è¼‰ã›ãŸ
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ Liquid ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–ã—ã€**ã‚¸ãƒ§ãƒ–è¿½åŠ ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãã ã‘**
- ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã«ã‚ˆã‚Šæœ¬ç•ªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ **300 MB å°** ã¾ã§å‰Šæ¸›

ã“ã‚Œã§ Redshift ã¸ã®æ—¥æ¬¡ãƒãƒ«ã‚¯ãƒ­ãƒ¼ãƒ‰ãŒ **ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ & é«˜é€Ÿ & ä½ã‚³ã‚¹ãƒˆ** ã§å®Ÿç¾ã§ãã¾ã—ãŸã€‚ãœã²è©¦ã—ã¦ã¿ã¦ä¸‹ã•ã„ï¼

---
## å‚è€ƒè¨˜äº‹
* [Dockerã‚’æ´»ç”¨ã—ãŸLambdaã®é–‹ç™ºï¼†æœ¬ç•ªç’°å¢ƒã®ãŠã™ã™ã‚æ§‹æˆ](https://zenn.dev/konan/articles/efd004b1810463)
* [Embulk v0.11ã‚’AWS Lambdaä¸Šã§å‹•ã‹ã™](https://zenn.dev/ikoba/articles/run-embulk-on-lambda)